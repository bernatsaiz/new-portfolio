---
const CHARS = "01.,;:-_=|/\\[]+*#@";
const COLS = 80;
const ROWS = 40;
---
<div class="ascii-bg" id="ascii-bg" aria-hidden="true">
  <div class="ascii-bg__grid" id="ascii-grid"></div>
</div>

<script define:vars={{ COLS, ROWS }}>
  const CHARS = "01.,;:-_=|/\\[]+*#@";
  const container = document.getElementById("ascii-bg");
  const gridEl = document.getElementById("ascii-grid");

  function randomChar() {
    return CHARS[Math.floor(Math.random() * CHARS.length)];
  }

  const cells = [];
  gridEl.style.setProperty("--cols", COLS);
  gridEl.style.setProperty("--rows", ROWS);

  for (let i = 0; i < ROWS * COLS; i++) {
    const span = document.createElement("span");
    span.className = "ascii-bg__cell";
    span.textContent = randomChar();
    span.dataset.index = String(i);
    gridEl.appendChild(span);
    cells.push(span);
  }

  function getIndexFromMouse(clientX, clientY) {
    const rect = container.getBoundingClientRect();
    const x = (clientX - rect.left) / rect.width;
    const y = (clientY - rect.top) / rect.height;
    const col = Math.floor(x * COLS);
    const row = Math.floor(y * ROWS);
    return { row, col, index: row * COLS + col };
  }

  function updateCell(index, intensity = 1) {
    const i = Math.max(0, Math.min(index, cells.length - 1));
    cells[i].textContent = randomChar();
    cells[i].style.opacity = 0.15 + intensity * 0.35;
    cells[i].classList.add("ascii-bg__cell--active");
    clearTimeout(cells[i]._reset);
    cells[i]._reset = setTimeout(() => {
      cells[i].style.opacity = "";
      cells[i].classList.remove("ascii-bg__cell--active");
    }, 400);
  }

  const RADIUS = 3;
  let mouseThrottle = 0;

  window.addEventListener("mousemove", (e) => {
    if (Date.now() - mouseThrottle < 40) return;
    mouseThrottle = Date.now();
    const rect = container.getBoundingClientRect();
    if (e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) return;
    const { row, col, index } = getIndexFromMouse(e.clientX, e.clientY);
    for (let dr = -RADIUS; dr <= RADIUS; dr++) {
      for (let dc = -RADIUS; dc <= RADIUS; dc++) {
        const r = row + dr;
        const c = col + dc;
        if (r < 0 || r >= ROWS || c < 0 || c >= COLS) continue;
        const dist = Math.sqrt(dr * dr + dc * dc);
        const intensity = 1 - dist / (RADIUS + 1);
        updateCell(r * COLS + c, Math.max(0, intensity));
      }
    }
  });

  setInterval(() => {
    const i = Math.floor(Math.random() * cells.length);
    if (Math.random() < 0.15) updateCell(i, 0.3);
  }, 200);
</script>

<style>
  .ascii-bg {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    pointer-events: none;
    z-index: 0;
  }

  .ascii-bg__grid {
    display: grid;
    grid-template-columns: repeat(var(--cols), 1fr);
    grid-template-rows: repeat(var(--rows), 1fr);
    width: 100%;
    height: 100%;
    gap: 0;
  }

  .ascii-bg__cell {
    font-family: "SF Mono", "Consolas", "Liberation Mono", monospace;
    font-size: clamp(0.35rem, 1.1vw, 0.55rem);
    line-height: 1;
    color: #00d4ff;
    opacity: 0.12;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.15s ease;
  }

  .ascii-bg__cell--active {
    color: #fff;
  }
</style>

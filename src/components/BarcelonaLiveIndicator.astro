---
interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;
---

<aside class:list={["barcelona-live", className]} data-bcn-live aria-label="Barcelona: hora, temps i qualitat de l'aire">
  <div class="barcelona-live__head">
    <span class="barcelona-live__city">Barcelona</span>
  </div>
  <div class="barcelona-live__lines">
    <div class="barcelona-live__line"><span class="barcelona-live__value" data-live-time>--:--:--</span></div>
    <div class="barcelona-live__line barcelona-live__value--weather">
      <span class="barcelona-live__weather-icon" data-live-weather-icon aria-hidden="true">·</span>
      <span class="barcelona-live__weather-temp" data-live-weather>...</span>
    </div>
    <div class="barcelona-live__line barcelona-live__air-wrap" title="PM2.5 µg/m³. Good ≤25, Moderate ≤40, Bad >40.">
      <span class="barcelona-live__air-tag">AQI</span>
      <span class="barcelona-live__air-dot" data-live-air-dot aria-hidden="true"></span>
      <span class="barcelona-live__value barcelona-live__air" data-live-air-tone="na" data-live-air>...</span>
    </div>
  </div>
</aside>

<script>
  type AirTone = "good" | "moderate" | "bad" | "na";

  const WEATHER_URL =
    "https://api.open-meteo.com/v1/forecast?latitude=41.38&longitude=2.17&current=temperature_2m,weather_code&timezone=Europe%2FMadrid";
  const AIR_URL =
    "https://analisi.transparenciacatalunya.cat/resource/tasf-thgu.json?municipi=Barcelona&$limit=100";

  const CLOCK_TZ = "Europe/Madrid";
  const WEATHER_REFRESH_MS = 10 * 60 * 1000;
  const AIR_REFRESH_MS = 15 * 60 * 1000;

  function fetchWithTimeout(url: string, timeout = 7000) {
    const controller = new AbortController();
    const timer = window.setTimeout(() => controller.abort(), timeout);
    return fetch(url, { signal: controller.signal })
      .then((res) => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .finally(() => window.clearTimeout(timer));
  }

  function weatherFromCode(code: number) {
    if (code === 0) return { icon: "☀", label: "Clear" };
    if (code === 1 || code === 2) return { icon: "⛅", label: "Partly cloudy" };
    if (code === 3) return { icon: "☁", label: "Cloudy" };
    if (code === 45 || code === 48) return { icon: "〰", label: "Fog" };
    if ([51, 53, 55, 56, 57].includes(code)) return { icon: "☂", label: "Drizzle" };
    if ([61, 63, 65, 66, 67, 80, 81, 82].includes(code)) return { icon: "☔", label: "Rain" };
    if ([71, 73, 75, 77, 85, 86].includes(code)) return { icon: "❄", label: "Snow" };
    if ([95, 96, 99].includes(code)) return { icon: "⚡", label: "Thunderstorm" };
    return { icon: "•", label: "—" };
  }

  function toneFromPm25(µg: number): AirTone {
    if (µg <= 25) return "good";
    if (µg <= 40) return "moderate";
    return "bad";
  }

  function labelFromTone(tone: AirTone) {
    if (tone === "good") return "Good";
    if (tone === "moderate") return "Moderate";
    if (tone === "bad") return "Bad";
    return "—";
  }

  function setupLivePanel(root: HTMLElement) {
    const timeEl = root.querySelector<HTMLElement>("[data-live-time]");
    const weatherEl = root.querySelector<HTMLElement>("[data-live-weather]");
    const weatherIconEl = root.querySelector<HTMLElement>("[data-live-weather-icon]");
    const airEl = root.querySelector<HTMLElement>("[data-live-air]");

    if (!timeEl || !weatherEl || !weatherIconEl || !airEl) return;

    const timeFmt = new Intl.DateTimeFormat("en-GB", {
      timeZone: CLOCK_TZ,
      hour12: false,
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });

    const updateClock = () => {
      timeEl.textContent = timeFmt.format(new Date());
    };

    const refreshWeather = async () => {
      try {
        const json = await fetchWithTimeout(WEATHER_URL);
        const current = (json as { current?: { temperature_2m?: number; weather_code?: number } }).current;
        if (!current) throw new Error("Missing weather");

        const temperature = Number(current.temperature_2m);
        const code = Number(current.weather_code);
        const { icon, label } = weatherFromCode(Number.isFinite(code) ? code : -1);
        const tempText = Number.isFinite(temperature) ? `${Math.round(temperature)}°C` : "—°C";

        weatherIconEl.textContent = icon;
        weatherEl.textContent = tempText;
      } catch {
        weatherIconEl.textContent = "•";
        weatherEl.textContent = "—";
      }
    };

    const refreshAir = async () => {
      try {
        const rows = (await fetchWithTimeout(AIR_URL)) as Record<string, unknown>[];
        if (!Array.isArray(rows) || rows.length === 0) throw new Error("No data");

        const now = new Date();
        let hour1Based = now.getHours() + 1;
        if (hour1Based > 24) hour1Based = 24;

        const pm25Rows = rows.filter(
          (r) => r.municipi === "Barcelona" && String(r.magnitud) === "9" && (r.tipus_estacio === "background" || r.tipus_estacio === "urban")
        );
        const record = pm25Rows[0];
        if (!record) throw new Error("No PM2.5");

        let key = "h" + String(hour1Based).padStart(2, "0");
        let µg: number | null = null;
        for (let h = hour1Based; h >= 1 && µg === null; h--) {
          const k = "h" + String(h).padStart(2, "0");
          const v = record[k];
          if (v !== undefined && v !== null && String(v).trim() !== "") {
            const n = Number(v);
            if (Number.isFinite(n)) µg = n;
          }
        }
        if (µg === null) throw new Error("No hourly value");
        if (!Number.isFinite(µg)) throw new Error("Invalid value");

        const tone = toneFromPm25(µg);
        const label = labelFromTone(tone);
        airEl.textContent = label;
        airEl.setAttribute("data-live-air-tone", tone);
        const dotEl = root.querySelector<HTMLElement>("[data-live-air-dot]");
        if (dotEl) dotEl.setAttribute("data-tone", tone);
        const wrap = root.querySelector<HTMLElement>(".barcelona-live__air-wrap");
        if (wrap) wrap.title = `PM2.5 ${Math.round(µg)} µg/m³ — ${label}. Good ≤25, Moderate ≤40, Bad >40.`;
      } catch {
        airEl.textContent = "—";
        airEl.setAttribute("data-live-air-tone", "na");
        const dotEl = root.querySelector<HTMLElement>("[data-live-air-dot]");
        if (dotEl) dotEl.removeAttribute("data-tone");
        const wrap = root.querySelector<HTMLElement>(".barcelona-live__air-wrap");
        if (wrap) wrap.title = "Air quality (PM2.5 µg/m³). Data temporarily unavailable.";
      }
    };

    updateClock();
    refreshWeather();
    refreshAir();

    window.setInterval(updateClock, 1000);
    window.setInterval(refreshWeather, WEATHER_REFRESH_MS);
    window.setInterval(refreshAir, AIR_REFRESH_MS);
  }

  document.querySelectorAll<HTMLElement>("[data-bcn-live]").forEach(setupLivePanel);
</script>

<style>
  .barcelona-live {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
    font-family: "JetBrains Mono", monospace;
    font-weight: 400;
    letter-spacing: 0.1em;
    color: #fff;
    text-align: right;
  }

  .barcelona-live__head {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    margin: 0;
  }

  .barcelona-live__city {
    font-size: clamp(0.875rem, 1.1vw, 1.0625rem);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: #fff;
    line-height: 1.2;
  }

  .barcelona-live__lines {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.15rem;
  }

  .barcelona-live__line {
    font-size: clamp(0.875rem, 1.1vw, 1.0625rem);
    color: rgba(255, 255, 255, 0.7);
    letter-spacing: 0.04em;
    text-align: right;
    line-height: 1.3;
  }

  .barcelona-live__line.barcelona-live__value--weather {
    display: flex;
    justify-content: flex-end;
    align-items: baseline;
    gap: 0.25rem;
  }

  .barcelona-live__value {
    margin: 0;
    min-width: 0;
  }

  .barcelona-live__value--weather {
    display: inline-flex;
    align-items: baseline;
    gap: 0.25rem;
  }

  .barcelona-live__weather-icon {
    color: rgba(255, 255, 255, 0.85);
    flex-shrink: 0;
  }

  .barcelona-live__line.barcelona-live__air-wrap {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.35rem;
  }

  .barcelona-live__air-tag {
    font-size: 0.625rem;
    letter-spacing: 0.08em;
    color: rgba(255, 255, 255, 0.4);
    text-transform: uppercase;
  }

  .barcelona-live__air-dot {
    width: 0.3rem;
    height: 0.3rem;
    border-radius: 999px;
    flex-shrink: 0;
    background: rgba(255, 255, 255, 0.35);
  }

  .barcelona-live__air-dot[data-tone="good"] {
    background: #6bc98a;
  }

  .barcelona-live__air-dot[data-tone="moderate"] {
    background: #d4a84b;
  }

  .barcelona-live__air-dot[data-tone="bad"] {
    background: #c75c5c;
  }

  .barcelona-live__air {
    color: rgba(255, 255, 255, 0.75);
  }

  .barcelona-live__air[data-live-air-tone="good"] {
    color: rgba(255, 255, 255, 0.85);
  }

  .barcelona-live__air[data-live-air-tone="moderate"] {
    color: rgba(255, 255, 255, 0.8);
  }

  .barcelona-live__air[data-live-air-tone="bad"] {
    color: rgba(255, 255, 255, 0.85);
  }

  @media (max-width: 900px) {
    .barcelona-live {
      align-items: flex-start;
      text-align: left;
    }

    .barcelona-live__head {
      justify-content: flex-start;
    }

    .barcelona-live__lines {
      align-items: flex-start;
    }

    .barcelona-live__line {
      text-align: left;
      font-size: clamp(0.8125rem, 3.5vw, 1rem);
    }

    .barcelona-live__line.barcelona-live__value--weather {
      justify-content: flex-start;
    }

    .barcelona-live__line.barcelona-live__air-wrap {
      justify-content: flex-start;
    }

    .barcelona-live__city {
      font-size: clamp(0.8125rem, 3.5vw, 1rem);
    }
  }
</style>

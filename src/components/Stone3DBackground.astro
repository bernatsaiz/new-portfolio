---
// Fons 3D: pedra transparent amb refracció, rotació amb el ratolí
---
<canvas id="stone-3d-canvas" class="stone-3d" aria-hidden="true"></canvas>

<script>
  import * as THREE from "three";

  const canvas = document.getElementById("stone-3d-canvas");
  if (!canvas) throw new Error("stone-3d-canvas not found");

  const ELECTRIC_BLUE = 0x00d4ff;
  const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(ELECTRIC_BLUE, 1);
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1;
  renderer.outputColorSpace = THREE.SRGBColorSpace;

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(ELECTRIC_BLUE);

  const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
  camera.position.z = 4.5;

  function createEnvMap() {
    const size = 32;
    const arr = [];
    const canvas = document.createElement("canvas");
    canvas.width = size;
    canvas.height = size;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "#00d4ff";
    ctx.fillRect(0, 0, size, size);
    for (let i = 0; i < 6; i++) arr.push(canvas);
    const cubeTex = new THREE.CubeTexture(arr);
    cubeTex.needsUpdate = true;
    return cubeTex;
  }

  const envMap = createEnvMap();
  scene.environment = envMap;

  const geometry = new THREE.IcosahedronGeometry(1, 2);
  const material = new THREE.MeshPhysicalMaterial({
    color: 0xffffff,
    transparent: true,
    opacity: 0.92,
    transmission: 1,
    thickness: 0.4,
    roughness: 0.05,
    metalness: 0,
    ior: 1.5,
    envMapIntensity: 1,
  });
  const stone = new THREE.Mesh(geometry, material);
  scene.add(stone);

  let mouse = { x: 0, y: 0 };
  let targetRotation = { x: 0, y: 0 };
  let currentRotation = { x: 0, y: 0 };
  let isDown = false;
  let prevMouse = { x: 0, y: 0 };

  function onResize() {
    const w = window.innerWidth;
    const h = window.innerHeight;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h);
  }

  function onPointerMove(e) {
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    if (isDown) {
      targetRotation.y += (e.clientX - prevMouse.x) * 0.008;
      targetRotation.x += (e.clientY - prevMouse.y) * 0.008;
    }
    prevMouse.x = e.clientX;
    prevMouse.y = e.clientY;
  }

  function onPointerDown() {
    isDown = true;
  }

  function onPointerUp() {
    isDown = false;
  }

  window.addEventListener("resize", onResize);
  window.addEventListener("pointermove", onPointerMove);
  window.addEventListener("pointerdown", onPointerDown);
  window.addEventListener("pointerup", onPointerUp);
  window.addEventListener("pointerleave", onPointerUp);

  function animate() {
    requestAnimationFrame(animate);
    if (!isDown) {
      targetRotation.x += (mouse.y * 0.4 - targetRotation.x) * 0.02;
      targetRotation.y += (mouse.x * 0.4 - targetRotation.y) * 0.02;
    }
    const damp = 0.08;
    currentRotation.x += (targetRotation.x - currentRotation.x) * damp;
    currentRotation.y += (targetRotation.y - currentRotation.y) * damp;
    stone.rotation.x = currentRotation.x;
    stone.rotation.y = currentRotation.y;
    renderer.render(scene, camera);
  }
  animate();
</script>

<style>
  .stone-3d {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: auto;
    display: block;
  }
</style>

---
import BaseLayout from "../layouts/BaseLayout.astro";
import { FaultyTerminalBackground } from "../components/FaultyTerminalBackground";
import TextScramble from "../components/TextScramble.astro";
import BarcelonaLiveIndicator from "../components/BarcelonaLiveIndicator.astro";
import { projects } from "../data/projects";
import { otherWork } from "../data/otherWork";
import { experiments } from "../data/experiments";
import "../styles/global.css";
import "../styles/home.css";

---
<BaseLayout title="Bernat Saiz — Data Visualization & Information Design" description="Data Visualization & Information Design." variant="landing">

  <section class="hero">
    <FaultyTerminalBackground
      client:load
      dpr={1}
      scale={2.2}
      gridMul={[2, 1]}
      digitSize={1.2}
      timeScale={2.2}
      scanlineIntensity={0}
      glitchAmount={1.15}
      flickerAmount={0.25}
      curvature={0.1}
      tint="#151437"
      backgroundColor="#191853"
      mouseReact={true}
      mouseStrength={0.7}
      pageLoadAnimation={true}
      brightness={1}
      chromaticAberration={0}
      dither={0.1}
      class="hero__bg"
    />
    <div class="hero__content">
      <div class="hero__top">
        <div class="hero__top-head">
          <h1 class="hero__name">Bernat Saiz</h1>
          <p class="hero__tagline">Information design and data visualization</p>
          <div class="hero__context">
            <span class="hero__context-line">Currently @ Domestic Data Streamers</span>
          </div>
        </div>
        <a href={`${import.meta.env.BASE_URL}barcelona`} class="hero__live-wrap" aria-label="Barcelona live: hora, temps i qualitat de l'aire">
          <BarcelonaLiveIndicator class="hero__live-indicator" />
        </a>
      </div>
      <div class="hero__bottom">
        <nav class="hero__nav" aria-label="Navegació principal">
          <TextScramble text="1 WORK" href={`${import.meta.env.BASE_URL}#work`} class="hero__nav-link" />
          <TextScramble text="2 EXPERIMENTS" href={`${import.meta.env.BASE_URL}#experiments`} class="hero__nav-link" />
          <TextScramble text="3 INFO" href={`${import.meta.env.BASE_URL}#info`} class="hero__nav-link" />
        </nav>
      </div>
    </div>
  </section>

  <section class="intro" id="info" aria-labelledby="intro-heading">
    <div class="intro__inner">
      <p class="intro__bio">
        Information designer and data journalist specialized in visual storytelling
        for editorial, civic, and public-interest contexts. Focused on transforming
        complex information into clear, honest, and structured visual systems.
      </p>
      <a href={`${import.meta.env.BASE_URL}info`} class="intro__link"><TextScramble text="Full profile " tag="span" /> <span class="link-arrow" aria-hidden="true">&rarr;</span></a>
    </div>
  </section>

  <section class="work" id="work" aria-labelledby="work-heading">
    <div class="work__inner">
      <header class="work__header">
        <h2 id="work-heading" class="section-label">Selected Work</h2>
      </header>

      <div class="work__list">
      {projects.map((project, i) => (
        <article class="project-card" style={`--stagger: ${i}`}>
          <a href={`${import.meta.env.BASE_URL}work/${project.slug}`} class="project-card__entire-link" aria-hidden="true" tabindex="-1"></a>
          <a href={`${import.meta.env.BASE_URL}work/${project.slug}`} class="project-card__image-link">
            <img
              src={`${import.meta.env.BASE_URL}${project.images[0].replace(/^\//, "")}`}
              alt={project.title}
              width="1200"
              height="675"
              loading={i < 2 ? "eager" : "lazy"}
              class="project-card__img"
            />
          </a>
          <div class="project-card__body">
            <span class="project-card__num">{String(i + 1).padStart(2, "0")}</span>
            <h3 class="project-card__title">
              <a href={`${import.meta.env.BASE_URL}work/${project.slug}`}>{project.title}</a>
            </h3>
            <p class="project-card__subtitle">{project.subtitle}</p>
            <div class="project-card__meta">
              <span>{project.year}</span>
              {project.tools && project.tools.length > 0 && (
                <>
                  <span class="project-card__dot">&middot;</span>
                  <span>{project.tools.slice(0, 3).join(", ")}</span>
                </>
              )}
            </div>
            <a href={`${import.meta.env.BASE_URL}work/${project.slug}`} class="project-card__link">
              <TextScramble text="View project " tag="span" /> <span class="link-arrow" aria-hidden="true">&rarr;</span>
            </a>
          </div>
        </article>
      ))}
      </div>
    </div>
  </section>

  <section class="other-work" id="other-work" aria-labelledby="other-work-heading">
    <div class="other-work__inner">
      <header class="other-work__header">
        <h2 id="other-work-heading" class="section-label">Other relevant work</h2>
        <p class="other-work__intro">A talk and a podcast—media, journalism, and creative formats I'm proud of, outside the main design portfolio.</p>
      </header>
      <div class="other-work__list">
        {otherWork.map((item, i) => (
          <article class="project-card other-work-card" style={`--stagger: ${i}`}>
            <a href={item.url} target="_blank" rel="noopener noreferrer" class="project-card__entire-link" aria-hidden="true" tabindex="-1"></a>
            {item.image ? (
              <a href={item.url} target="_blank" rel="noopener noreferrer" class="project-card__image-link">
                <img
                  src={item.image.startsWith("http") ? item.image : `${import.meta.env.BASE_URL}${item.image.replace(/^\//, "")}`}
                  alt={item.title}
                  width="800"
                  height="450"
                  loading="lazy"
                  class="project-card__img"
                />
              </a>
            ) : (
              <a href={item.url} target="_blank" rel="noopener noreferrer" class="project-card__image-link">
                <span class="project-card__subtitle">{item.kind}</span>
              </a>
            )}
            <div class="project-card__body">
              <span class="project-card__num">{String(i + 1).padStart(2, "0")}</span>
              <h3 class="project-card__title">
                <a href={item.url} target="_blank" rel="noopener noreferrer">{item.title}</a>
              </h3>
              <p class="project-card__subtitle">{item.subtitle}</p>
              <div class="project-card__meta">
                {item.year && <span>{item.year}</span>}
                <span class="project-card__dot">&middot;</span>
                <span>{item.kind}</span>
              </div>
              <a href={item.url} target="_blank" rel="noopener noreferrer" class="project-card__link">
                <TextScramble text={`${item.ctaText} `} tag="span" /> <span class="link-arrow" aria-hidden="true">&rarr;</span>
              </a>
            </div>
          </article>
        ))}
      </div>
    </div>
  </section>

  <section class="experiments" id="experiments" aria-labelledby="experiments-heading">
    <div class="experiments__inner">
      <header class="experiments__header">
        <h2 id="experiments-heading" class="section-label">Experiments</h2>
        <p class="experiments__intro">Small experiments and prototypes made with vibe coding (AI-assisted).</p>
      </header>
      <div class="experiments__list">
        {experiments.map((exp, i) => (
          <article class="project-card experiment-card" style={`--stagger: ${i}`}>
            <a href={exp.url} target="_blank" rel="noopener noreferrer" class="project-card__entire-link" aria-hidden="true" tabindex="-1"></a>
            <a href={exp.url} target="_blank" rel="noopener noreferrer" class="project-card__image-link">
              <img
                src={exp.image}
                alt={exp.title}
                width="800"
                height="450"
                loading="lazy"
                class="project-card__img"
              />
            </a>
            <div class="project-card__body">
              <span class="project-card__num">{String(i + 1).padStart(2, "0")}</span>
              <h3 class="project-card__title">
                <a href={exp.url} target="_blank" rel="noopener noreferrer">{exp.title}</a>
              </h3>
              <p class="project-card__subtitle">{exp.shortDescription}</p>
              <div class="project-card__meta">
                {exp.year && <span>{exp.year}</span>}
                <span class="project-card__dot">&middot;</span>
                <span>{exp.tags?.[0] || "Experiment"}</span>
              </div>
              <a href={exp.url} target="_blank" rel="noopener noreferrer" class="project-card__link">
                <TextScramble text="View demo " tag="span" /> <span class="link-arrow" aria-hidden="true">&rarr;</span>
              </a>
            </div>
          </article>
        ))}
      </div>
    </div>
  </section>

  <footer class="site-footer" id="contact">
    <div class="site-footer__inner">
      <p class="site-footer__contact">
        <button type="button" class="site-footer__email-trigger" data-email="bernatsaiz@gmail.com" aria-label="Email, click to copy">Email</button>
        <span class="site-footer__sep">&middot;</span>
        <a href="https://www.linkedin.com/in/bernatsaiz/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn (opens in new window)">LinkedIn</a>
      </p>
      <a href={`${import.meta.env.BASE_URL}info`} class="site-footer__profile"><TextScramble text="Full profile " tag="span" /> <span class="link-arrow" aria-hidden="true">&rarr;</span></a>
    </div>
  </footer>

</BaseLayout>

<script>
  function initSectionReveal() {
    const sections = document.querySelectorAll<HTMLElement>(".intro, .work, .other-work, .experiments");
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("in-view");
          }
        });
      },
      { rootMargin: "0px 0px -12% 0px", threshold: 0 }
    );
    sections.forEach((el) => observer.observe(el));
  }
  function initEmailCopy() {
    const btn = document.querySelector<HTMLButtonElement>(".site-footer__email-trigger");
    if (!btn) return;
    btn.addEventListener("click", () => {
      const email = btn.getAttribute("data-email");
      if (!email) return;
      navigator.clipboard.writeText(email).then(() => {
        const orig = btn.textContent;
        btn.textContent = "Copied!";
        setTimeout(() => { btn.textContent = orig; }, 1500);
      });
    });
  }
  function initProjectCardLinkScramble() {
    const cards = document.querySelectorAll<HTMLElement>(".project-card");
    cards.forEach((card) => {
      const scrambleEl = card.querySelector<HTMLElement>(".project-card__link .text-scramble");
      if (!scrambleEl) return;
      const trigger = () => {
        scrambleEl.dispatchEvent(new MouseEvent("mouseenter", { bubbles: true }));
      };
      card.addEventListener("mouseenter", trigger);
      card.addEventListener("focusin", trigger);
    });
  }

  const DRAG_THRESHOLD = 10;

  function initDraggableCards() {
    const cards = document.querySelectorAll<HTMLElement>(".project-card");
    cards.forEach((card) => {
      let startX = 0;
      let startY = 0;
      let clone: HTMLElement | null = null;
      let didDrag = false;
      let moveHandler: ((e: MouseEvent | TouchEvent) => void) | null = null;
      let upHandler: (() => void) | null = null;

      function getCoords(e: MouseEvent | TouchEvent): { x: number; y: number } {
        if ("touches" in e) {
          const t = e.type.includes("end") || e.type.includes("cancel") ? (e as TouchEvent).changedTouches[0] : (e as TouchEvent).touches[0];
          return { x: t.clientX, y: t.clientY };
        }
        return { x: (e as MouseEvent).clientX, y: (e as MouseEvent).clientY };
      }

      let cloneW = 0;
      let cloneH = 0;

      const link = card.querySelector<HTMLAnchorElement>(".project-card__entire-link");
      const href = link?.getAttribute("href");

      function start(e: MouseEvent | TouchEvent) {
        e.preventDefault();
        const { x, y } = getCoords(e);
        startX = x;
        startY = y;
        didDrag = false;
        clone = null;

        moveHandler = (e2: MouseEvent | TouchEvent) => {
          const { x: cx, y: cy } = getCoords(e2);
          const dx = cx - startX;
          const dy = cy - startY;
          if (!clone && (Math.abs(dx) > DRAG_THRESHOLD || Math.abs(dy) > DRAG_THRESHOLD)) {
            didDrag = true;
            const rect = card.getBoundingClientRect();
            cloneW = rect.width;
            cloneH = rect.height;
            clone = card.cloneNode(true) as HTMLElement;
            clone.classList.add("project-card--drag-clone");
            clone.setAttribute("aria-hidden", "true");
            clone.style.width = `${cloneW}px`;
            clone.style.left = `${cx - cloneW / 2}px`;
            clone.style.top = `${cy - cloneH / 2}px`;
            document.body.appendChild(clone);
          }
          if (clone) {
            clone.style.left = `${cx - cloneW / 2}px`;
            clone.style.top = `${cy - cloneH / 2}px`;
          }
        };
        upHandler = () => {
          document.removeEventListener("mousemove", moveHandler!);
          document.removeEventListener("touchmove", moveHandler!);
          document.removeEventListener("mouseup", upHandler!);
          document.removeEventListener("touchend", upHandler!);
          if (!didDrag && href) {
            const a = card.querySelector<HTMLAnchorElement>(".project-card__entire-link");
            if (a) a.click();
          }
          moveHandler = null;
          upHandler = null;
        };

        document.addEventListener("mousemove", moveHandler);
        document.addEventListener("touchmove", moveHandler, { passive: true });
        document.addEventListener("mouseup", upHandler);
        document.addEventListener("touchend", upHandler);
      }

      card.addEventListener("mousedown", start, { passive: false });
      card.addEventListener("touchstart", start, { passive: false });

      card.addEventListener(
        "click",
        (e) => {
          if (didDrag) {
            e.preventDefault();
            e.stopPropagation();
          }
        },
        true
      );
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      initSectionReveal();
      initEmailCopy();
      initProjectCardLinkScramble();
      initDraggableCards();
    });
  } else {
    initSectionReveal();
    initEmailCopy();
    initProjectCardLinkScramble();
    initDraggableCards();
  }
</script>
